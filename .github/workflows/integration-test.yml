name: Integration Testing

on:
  pull_request:
    branches:
      - main
  schedule:
    # Run integration tests daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  full-stack-integration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Coq 8.18+
      run: |
        sudo apt-get update
        sudo apt-get install -y opam
        opam init -y --disable-sandboxing
        opam switch create coq-pxl 4.14.1
        eval $(opam env)
        opam install -y coq.8.18.0
        
    - name: Set up Python 3.11+
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: "STEP 1: Build Coq Proof Suite"
      run: |
        eval $(opam env)
        coq_makefile -f _CoqProject -o CoqMakefile
        make -f CoqMakefile -j2
        python3 tools/axiom_inventory.py
        python3 tools/axiom_gate.py
        echo "✅ Coq proofs verified"
        
    - name: "STEP 2: Verify Runtime Alignment"
      run: |
        eval $(opam env)
        python3 scripts/boot_aligned_agent.py
        if ! python3 scripts/boot_aligned_agent.py 2>&1 | grep -q "Current status: ALIGNED"; then
          echo "ERROR: Agent alignment failed"
          exit 1
        fi
        echo "✅ Runtime aligned to proofs"
        
    - name: "STEP 3: Initialize Agent System"
      run: |
        python3 scripts/system_mode_initializer.py --mode DEMO_STABLE
        mkdir -p sandbox_integration
        echo "✅ Agent system initialized"
        
    - name: "STEP 4: Run Agent Smoke Test"
      run: |
        timeout 60 python3 scripts/start_agent.py \
          --objective "Integration test: verify read access to state/" \
          --read-only \
          --budget-sec 30 || true
        echo "✅ Agent smoke test completed"
        
    - name: "STEP 5: Validate Investor Dashboard"
      run: |
        # Dashboard reads axiom_footprint.json which should exist from Step 1
        python3 scripts/investor_dashboard.py || echo "⚠️  Dashboard completed with warnings"
        echo "✅ Dashboard validation completed"
        
    - name: "STEP 6: Full Test Suite"
      run: |
        eval $(opam env)
        python3 test_lem_discharge.py
        if ! python3 test_lem_discharge.py 2>&1 | grep -q "Overall status: PASS"; then
          echo "ERROR: Full test suite failed"
          exit 1
        fi
        echo "✅ Full test suite PASS"
        
    - name: Generate Integration Report
      if: always()
      run: |
        cat << 'EOF' > integration_report.txt
        ========================================
        INTEGRATION TEST REPORT
        ========================================
        Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: ${{ github.sha }}
        
        Components Tested:
        - Coq Proof Suite (8 axioms)
        - Runtime Alignment Verification
        - Agent System Initialization
        - Investor Dashboard
        - Full Test Suite
        
        Result: ${{ job.status }}
        ========================================
        EOF
        cat integration_report.txt
        
    - name: Upload Integration Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-artifacts
        path: |
          state/axiom_footprint.json
          state/alignment_*.json
          state/mission_profile.json
          integration_report.txt
        retention-days: 90
